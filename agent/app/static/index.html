<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Agent Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b141a; --me:#005c4b; --bot:#202c33; --text:#e9edef; --muted:#8696a0; }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto; }
    .wrap { max-width:820px; margin:0 auto; height:100vh; display:flex; flex-direction:column; }
    header { padding:14px 16px; border-bottom:1px solid #2a3942; font-weight:600; }
    #chat { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; }
    .you { justify-content:flex-end; }
    .msg { max-width:70%; padding:10px 12px; border-radius:12px; white-space:pre-wrap; }
    .me .msg { background:var(--me); border-bottom-right-radius:4px; }
    .bot .msg { background:var(--bot); border-bottom-left-radius:4px; }
    footer { display:flex; gap:8px; padding:12px; border-top:1px solid #2a3942; }
    input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #2a3942; background:#111b21; color:var(--text); }
    button { padding:10px 14px; border-radius:10px; border:0; background:#00a884; color:white; font-weight:600; cursor:pointer; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; }
    .code { background:#111b21; border:1px solid #2a3942; padding:8px; border-radius:8px; overflow:auto; }
    .typing {background: var(--bot);border-bottom-left-radius: 4px;display: inline-flex;align-items: center;gap: 6px;padding: 10px 12px;transform-origin: left center;  animation: bubblePulse 1.1s ease-in-out infinite;}
    @keyframes bubblePulse {
      0%, 100% { transform: scale(0.92); opacity: 0.9; }
      50%      { transform: scale(1.00); opacity: 1;   }
    }
    .dot { width: 6px; height: 6px; background: var(--text); border-radius: 50%;
          animation: blink 1.4s infinite both; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>💬 Agent Chat</header>
    <div id="chat"></div>
    <footer>
      <input id="q" placeholder="Ask about tariffs or prices… (e.g., price of gold yesterday)"/>
      <button id="send">Send</button>
    </footer>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('q');
    const sendBtn = document.getElementById('send');
    let typingRow = null;

  function showTyping() {
    if (typingRow) return;
    typingRow = document.createElement('div');
    typingRow.className = 'row bot';
    const bubble = document.createElement('div');
    bubble.className = 'msg typing';
    bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    typingRow.appendChild(bubble);
    chat.appendChild(typingRow);
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() {
    if (typingRow) {
      chat.removeChild(typingRow);
      typingRow = null;
    }
  }

    function addBubble(text, who='bot', extra={}) {
      const row = document.createElement('div');
      row.className = 'row ' + (who === 'me' ? 'you me' : 'bot');
      const bubble = document.createElement('div');
      bubble.className = 'msg';
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    async function ask(q) {
      addBubble(q, 'me');
      input.value = '';
      input.blur();
      sendBtn.disabled = true;
      const started = Date.now();
      showTyping();   // show dots while waiting
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: q })
        });
        const data = await res.json();
        const elapsed = Date.now() - started;
        if (elapsed < 600) {await new Promise(r => setTimeout(r, 600 - elapsed));} // ensure dots show at least 600ms
        hideTyping();  // hide dots when response arrives
        addBubble(data.answer );
      } catch (e) {
        addBubble('⚠️ Request failed. Check server logs.', 'bot');
        console.error(e);
      }
    }

    sendBtn.onclick = () => { if (input.value.trim()) ask(input.value.trim()); };
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && input.value.trim()) ask(input.value.trim()); });

    // warm greeting
    addBubble("Hi! Ask me:\n• What is the tariff situation between the US and the EU?\n• What is the price of gold yesterday?");
  </script>
</body>
</html>